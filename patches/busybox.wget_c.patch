--- busybox-1.15.2/networking/wget.c.orig	2009-10-08 00:59:09.000000000 +0000
+++ busybox-1.15.2/networking/wget.c	2009-11-14 21:55:37.000000000 +0000
@@ -471,6 +471,8 @@
 	FILE *sfp;
 	char *str;
 	int port;
+	char *p;
+	int nn;
 
 	if (!target->user)
 		target->user = xstrdup("anonymous:busybox@");
@@ -520,17 +522,24 @@
 	// Response is "227 garbageN1,N2,N3,N4,P1,P2[)garbage]
 	// Server's IP is N1.N2.N3.N4 (we ignore it)
 	// Server's port for data connection is P1*256+P2
-	str = strrchr(buf, ')');
-	if (str) str[0] = '\0';
-	str = strrchr(buf, ',');
-	if (!str) goto pasv_error;
-	port = xatou_range(str+1, 0, 255);
-	*str = '\0';
-	str = strrchr(buf, ',');
-	if (!str) goto pasv_error;
-	port += xatou_range(str+1, 0, 255) * 256;
-	set_nport(lsa, htons(port));
-
+	if (!(str = strrchr(buf, ')')))
+		goto pasv_error;
+	*str = 0;	// clear trailing '\0'
+	if (!(str = strrchr(buf, '(')))
+		goto pasv_error;
+	p = ++str;
+	for (nn=0; nn<4; nn++) {
+		if (!(str = strchr(str, ',')))
+			goto pasv_error;
+		*str++ = '.';
+	}
+	str[-1] = 0;
+	if (inet_aton(p, &lsa->u.sin.sin_addr) == 0)
+		goto pasv_error;
+	if (!(str = strchr((p=str), ',')))
+		goto pasv_error;
+	*str++ = 0;
+	set_nport(lsa, htons(xatou_range(p, 0, 255) * 256 + xatou_range(str, 0, 255)));
 	*dfpp = open_socket(lsa);
 
 	if (beg_range) {
