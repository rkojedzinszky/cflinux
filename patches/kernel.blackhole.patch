--- linux-2.4.30/include/linux/sysctl.h.orig	Mon Apr  4 03:42:20 2005
+++ linux-2.4.30/include/linux/sysctl.h	Fri Apr 29 15:19:55 2005
@@ -327,6 +327,8 @@
 	NET_TCP_DEFAULT_WIN_SCALE=105,
 	NET_TCP_MODERATE_RCVBUF=106,
 	NET_TCP_BIC_BETA=108,
+	NET_TCP_BLACKHOLE=200,
+	NET_UDP_BLACKHOLE=201,
 };
 
 enum {
--- linux-2.4.28/net/ipv4/tcp_ipv4.c.orig	2004-11-25 18:58:13.000000000 +0100
+++ linux-2.4.28/net/ipv4/tcp_ipv4.c	2004-11-25 19:06:29.000000000 +0100
@@ -73,6 +73,7 @@
 extern int sysctl_ip_default_ttl;
 int sysctl_tcp_tw_reuse = 0;
 int sysctl_tcp_low_latency = 0;
+int sysctl_tcp_blackhole = 0;
 
 /* Check TCP sequence numbers in ICMP packets. */
 #define ICMP_MIN_LENGTH 8
@@ -1193,6 +1194,10 @@
 	struct tcphdr rth;
 	struct ip_reply_arg arg;
 
+	/* never send reset if sysctl_tcp_blackhole is set */
+	if (sysctl_tcp_blackhole)
+		return;
+
 	/* Never send a reset in response to a reset. */
 	if (th->rst)
 		return;
--- linux-2.4.28/net/ipv4/udp.c.orig	2004-11-25 19:06:41.000000000 +0100
+++ linux-2.4.28/net/ipv4/udp.c	2004-11-25 20:28:09.000000000 +0100
@@ -115,6 +115,7 @@
 
 /* Shared by v4/v6 udp. */
 int udp_port_rover;
+int sysctl_udp_blackhole = 0;
 
 static int udp_v4_get_port(struct sock *sk, unsigned short snum)
 {
@@ -975,7 +976,8 @@
 		goto csum_error;
 
 	UDP_INC_STATS_BH(UdpNoPorts);
-	icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PORT_UNREACH, 0);
+	if (!sysctl_udp_blackhole)
+		icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PORT_UNREACH, 0);
 
 	/*
 	 * Hmm.  We got an UDP packet to a port to which we
--- linux-2.4.28/net/ipv4/sysctl_net_ipv4.c.orig	2004-11-25 18:58:22.000000000 +0100
+++ linux-2.4.28/net/ipv4/sysctl_net_ipv4.c	2004-11-25 20:28:40.000000000 +0100
@@ -60,6 +60,12 @@
 
 extern ctl_table ipv4_route_table[];
 
+/* From tcp_ipv4.c */
+extern int sysctl_tcp_blackhole;
+
+/* From udp.c */
+extern int sysctl_udp_blackhole;
+
 #ifdef CONFIG_SYSCTL
 
 static
@@ -268,6 +274,12 @@
  	{NET_TCP_MODERATE_RCVBUF, "tcp_moderate_rcvbuf",
 	 &sysctl_tcp_moderate_rcvbuf, sizeof(int), 0644, NULL,
 	 &proc_dointvec},
+	{NET_TCP_BLACKHOLE, "tcp_blackhole",
+	 &sysctl_tcp_blackhole, sizeof(int), 0644, NULL,
+	 &proc_dointvec},
+	{NET_UDP_BLACKHOLE, "udp_blackhole",
+	 &sysctl_udp_blackhole, sizeof(int), 0644, NULL,
+	 &proc_dointvec},
 	{0}
 };
 
