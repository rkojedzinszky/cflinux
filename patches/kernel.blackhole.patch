--- linux-2.6.17.13/net/ipv4/tcp_ipv4.c.orig	2006-09-09 05:23:25.000000000 +0200
+++ linux-2.6.17.13/net/ipv4/tcp_ipv4.c	2006-09-12 20:51:13.000000000 +0200
@@ -80,6 +80,7 @@
 
 int sysctl_tcp_tw_reuse;
 int sysctl_tcp_low_latency;
+int sysctl_tcp_blackhole = 0;
 
 /* Check TCP sequence numbers in ICMP packets. */
 #define ICMP_MIN_LENGTH 8
@@ -514,6 +515,10 @@
 	struct tcphdr rth;
 	struct ip_reply_arg arg;
 
+	/* never send reset if sysctl_tcp_blackhole is set */
+	if (sysctl_tcp_blackhole)
+		return;
+
 	/* Never send a reset in response to a reset. */
 	if (th->rst)
 		return;
--- linux-2.6.17.13/net/ipv4/sysctl_net_ipv4.c.orig	2006-09-09 05:23:25.000000000 +0200
+++ linux-2.6.17.13/net/ipv4/sysctl_net_ipv4.c	2006-09-12 20:57:48.000000000 +0200
@@ -31,6 +31,12 @@
 
 struct ipv4_config ipv4_config;
 
+/* From tcp_ipv4.c */
+extern int sysctl_tcp_blackhole;
+
+/* From udp.c */
+extern int sysctl_udp_blackhole;
+
 #ifdef CONFIG_SYSCTL
 
 static
@@ -688,6 +694,22 @@
 		.mode		= 0644,
 		.proc_handler	= &proc_dointvec
 	},
+	{
+		.ctl_name	= NET_IPV4_TCP_BLACKHOLE,
+		.procname	= "tcp_blackhole",
+		.data		= &sysctl_tcp_blackhole,
+		.maxlen		= sizeof(int),
+		.mode		= 0640,
+		.proc_handler	= &proc_dointvec
+	},
+	{
+		.ctl_name	= NET_IPV4_UDP_BLACKHOLE,
+		.procname	= "udp_blackhole",
+		.data		= &sysctl_udp_blackhole,
+		.maxlen		= sizeof(int),
+		.mode		= 0640,
+		.proc_handler	= &proc_dointvec
+	},
 	{ .ctl_name = 0 }
 };
 
--- linux-2.6.17.13/net/ipv4/udp.c.orig	2006-09-09 05:23:25.000000000 +0200
+++ linux-2.6.17.13/net/ipv4/udp.c	2006-09-12 21:00:23.000000000 +0200
@@ -121,6 +121,7 @@
 
 /* Shared by v4/v6 udp. */
 int udp_port_rover;
+int sysctl_udp_blackhole = 0;
 
 static int udp_v4_get_port(struct sock *sk, unsigned short snum)
 {
@@ -1157,7 +1158,8 @@
 		goto csum_error;
 
 	UDP_INC_STATS_BH(UDP_MIB_NOPORTS);
-	icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PORT_UNREACH, 0);
+	if (!sysctl_udp_blackhole)
+		icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PORT_UNREACH, 0);
 
 	/*
 	 * Hmm.  We got an UDP packet to a port to which we
--- linux-2.6.18/include/linux/sysctl.h.orig	2006-09-20 05:42:06.000000000 +0200
+++ linux-2.6.18/include/linux/sysctl.h	2006-09-30 11:30:06.000000000 +0200
@@ -411,6 +411,8 @@
 	NET_IPV4_TCP_WORKAROUND_SIGNED_WINDOWS=115,
 	NET_TCP_DMA_COPYBREAK=116,
 	NET_TCP_SLOW_START_AFTER_IDLE=117,
+	NET_IPV4_TCP_BLACKHOLE=200,
+	NET_IPV4_UDP_BLACKHOLE=201,
 };
 
 enum {
